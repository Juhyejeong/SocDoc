<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<!-- ==== #29. 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<mapper namespace="mypage">
	
	<!-- == 총 게시물 건수(totalCount)를 구하기(검색이 있을때와 검색이 없을때로 나뉜다.) == -->
	   <select id="getTotalCount" parameterType="HashMap" resultType="int">
	   	select count(*)
	   	from qnaBoard
		<if test='searchWord != ""'>
		     where subject like '%'|| lower(#{searchWord}) ||'%'
		</if> 
	   </select>
	  
	   
	 
	 <!-- == #154. 첨부파일이 있는 답변형 게시판의 페이징 처리한 글목록 가져오기 (검색이 있든지, 검색이 없든지 모두 다 포함한것)  
  		    먼저 #144 을 주석처리 한 후에 아래와 같이 한다.== -->
	   <select id="boardListSearchWithPaging" parameterType="HashMap" resultType="com.synergy.socdoc.member.QnaBoardVO">
		  	select qnaSeq, userid, subject, content, regDate, status, groupno, fk_seq, depthno 
			from 
			(
			    select rownum AS rno
			         , qnaSeq, userid, subject, content, regDate, status, groupno, fk_seq, depthno 
			    from
			    (
			        select qnaSeq, userid, subject, content,
			        	   to_char(regDate, 'yyyy-mm-dd hh24:mi:ss') as regDate, status, groupno, fk_seq, depthno 
			        from qnaBoard
			        <if test='searchWord != ""'>
				     where subject like '%'|| #{searchWord} ||'%'
				    </if>
			        start with fk_seq = 0
		        	connect by prior qnaSeq = fk_seq
		        	order siblings by groupno desc, qnaSeq desc
			    ) V
			) T
			where rno between #{startRno} and #{endRno}
	  </select>   
	  
	  
	  <!-- === #66.(댓글쓰기가 없는 게시판에서) 글 1개 보여주기 === -->
	   <select id="getView" parameterType="String" resultType="com.synergy.socdoc.member.QnaBoardVO">
		    select previousseq, previoussubject
		         , qnaSeq, userid, subject, content, regDate, status
		         , nextseq, nextsubject
			from
			(
			    select lag(qnaSeq, 1) over(order by qnaSeq asc) as previousseq 
			         , lag(subject, 1) over(order by qnaSeq asc) as previoussubject
			       
			         , qnaSeq, userid, subject, content
			         , to_char(regDate, 'yyyy-mm-dd hh24:mi:ss') as regDate ,status
			           
			         , lead(qnaSeq, 1) over(order by qnaSeq asc) as nextseq 
			         , lead(subject, 1) over(order by qnaSeq asc) as nextsubject
			    from qnaBoard
			) V
			where V.qnaSeq = #{qnaSeq}
	   </select>
	   
	   
      <!-- === 1개글 삭제하기 === -->
	  <delete id="deleteBoard" parameterType="HashMap">
		   delete from qnaBoard
		   where qnaSeq = #{qnaSeq}
	  </delete>
	  
	  <!-- === 내 건강 보기 === -->
	  <select id="viewMyHealth" parameterType="String" resultType="com.synergy.socdoc.member.MemberVO">
	    select height, weight, bloodType, allergy, history, medicine
		from member
		where userid = #{userid}
   	</select>
   	
 
	  
	  <!--  === 내 건강 새로추가 === -->
	   <update id="addHealth" parameterType="com.synergy.socdoc.member.MemberVO">
	   		update member 
			set height = #{height},
			    weight = #{weight},
			    bloodType = #{bloodType},
			    allergy = #{allergy},
			    history = #{history},
			    medicine = #{medicine}
			where userid = #{userid}
	   </update>
	   
	   
	   <!--  === 내 건강 초기화하기 === -->
	   <update id="delHealth" parameterType="String">
		    update member
			set height = null,
			    weight = null,
			    bloodType = null,
			    allergy = null,
			    history = null,
			    medicine = null
		   where userid = #{userid}
	   </update>
	   
	   
	   <!-- == 총 즐겨찾기 건수(totalCount)를 구하기 == -->
	   <select id="getTotalBookMarkCount" parameterType="HashMap" resultType="int">
	   	select count(*)
	   	from bookmark
	   </select>
	   
	   
	   <!-- == #154. 첨부파일이 있는 답변형 게시판의 페이징 처리한 글목록 가져오기 (검색이 있든지, 검색이 없든지 모두 다 포함한것)  
  		    먼저 #144 을 주석처리 한 후에 아래와 같이 한다.== -->
  		<!--    
	   <select id="boardListSearchWithPaging" parameterType="HashMap" resultType="com.synergy.socdoc.member.QnaBoardVO">
		  	select qnaSeq, userid, subject, content, regDate, status, groupno, fk_seq, depthno 
			from 
			(
			    select rownum AS rno
			         , qnaSeq, userid, subject, content, regDate, status, groupno, fk_seq, depthno 
			    from
			    (
			        select qnaSeq, userid, subject, content,
			        	   to_char(regDate, 'yyyy-mm-dd hh24:mi:ss') as regDate, status, groupno, fk_seq, depthno 
			        from qnaBoard
			        <if test='searchWord != ""'>
				     where subject like '%'|| #{searchWord} ||'%'
				    </if>
			        start with fk_seq = 0
		        	connect by prior qnaSeq = fk_seq
		        	order siblings by groupno desc, qnaSeq desc
			    ) V
			) T
			where rno between #{startRno} and #{endRno}
	  </select> 
	  -->  
	  
	   <!--  북마크 userid 들고오기 -->
	   <!--  
	   <select id="getUserid" resultType="String">
	 	   select distinct userid
		   from bookmark
		   order by userid
	   </select> 
	   -->
	   
	   <!-- 즐겨찾기 목록 가져오기 --> 
	   <resultMap type="HashMap" id="hpInfoMap">
   		<result property="dept" 	column="dept" 		javaType="String"/>
   		<result property="hpName" 	column="hpName" 	javaType="String"/>
   		<result property="phone" 	column="phone" 		javaType="String"/>
	   </resultMap>
	   <select id="bookMarkListSearchWithPaging" parameterType="HashMap" resultMap="hpInfoMap">
	 	   select H.dept AS depth
	      		, H.hpName AS hpName
	      		, H.phone AS phone
	 		from bookmark B join hospitalInfo H 
	 		on B.hpSeq = H.hpSeq
	 		where B.userid = #{userid}
	   </select> 
	
</mapper>